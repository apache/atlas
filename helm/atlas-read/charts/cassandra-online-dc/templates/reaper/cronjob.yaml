{{- if or .Values.global.svcIsolation.enabled .Values.global.globalSvcIsolation.enabled }}
{{- if .Values.reaper.enable -}}
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ template "cassandra.fullname" . }}-reaper-cron
  namespace: {{ .Values.Namespace }}
  labels:
    app: {{ template "cassandra.name" . }}-reaper
    release: {{ .Release.Name }}
    heritage: {{ .Release.Service }}
spec:
    schedule: "00 11 * * 6" #At 11 AM Saturday, UTC.
    failedJobsHistoryLimit: {{ .Values.reaper.failedJobsHistoryLimit }}
    successfulJobsHistoryLimit: {{ .Values.reaper.successfulJobsHistoryLimit }}
    concurrencyPolicy: {{ .Values.reaper.concurrencyPolicy }}
    jobTemplate:
      spec:
        activeDeadlineSeconds: {{ .Values.reaper.activeDeadlineSeconds }}
        backoffLimit: {{ .Values.reaper.backoffLimit }}
        template:
          spec:
            shareProcessNamespace: {{ .Values.reaper.shareProcessNamespace }}
            restartPolicy: {{ .Values.reaper.restartPolicy }}
            {{- $multiarchEnabled := and .Values.multiarch (eq .Values.multiarch.enabled true) }}
            {{- if or .Values.tolerations $multiarchEnabled }}
            tolerations:
            {{- if .Values.tolerations }}
            {{ toYaml .Values.tolerations | nindent 14 }}
            {{- end }}
            {{- if $multiarchEnabled }}
              - key: "archtype"
                operator: "Equal"
                value: "arm64"
                effect: "NoSchedule"
            {{- end }}
            {{- end }}
            initContainers:
              - name: create-reaper-keyspace
                image: {{ .Values.reaper.initContainer.image.repository }}:{{ .Values.reaper.initContainer.image.tag }}
                imagePullPolicy: {{ .Values.reaper.initContainer.image.pullPolicy }}
                command:
                  - /bin/bash
                  - -c
                  - |
                    python3 << 'EOF'
                    import time
                    import socket
                    
                    host = 'atlas-cassandra-online-dc.atlas.svc.cluster.local'
                    port = 9042
                    max_retries = 30
                    
                    # Wait for Cassandra to be reachable
                    for attempt in range(max_retries):
                        try:
                            print(f"Checking Cassandra availability (attempt {attempt + 1}/{max_retries})...")
                            sock = socket.socket(socket.AF_INET, socket.SOCK_STREAM)
                            sock.settimeout(5)
                            result = sock.connect_ex((host, port))
                            sock.close()
                            if result == 0:
                                print("Cassandra is reachable!")
                                break
                        except Exception as e:
                            print(f"Socket error: {e}")
                        time.sleep(5)
                    
                    # Now connect with cassandra-driver
                    from cassandra.cluster import Cluster
                    from cassandra.policies import DCAwareRoundRobinPolicy
                    from cassandra.io.libevreactor import LibevConnection
                    
                    print("Connecting to Cassandra...")
                    cluster = Cluster(
                        [host],
                        load_balancing_policy=DCAwareRoundRobinPolicy(local_dc='online-dc'),
                        connection_class=LibevConnection
                    )
                    session = cluster.connect()
                    
                    print("Creating keyspace reaper_db...")
                    session.execute("""
                        CREATE KEYSPACE IF NOT EXISTS reaper_db 
                        WITH replication = {'class': 'NetworkTopologyStrategy', 'online-dc': 3}
                        AND durable_writes = true
                    """)
                    print("Keyspace reaper_db created/verified successfully!")
                    cluster.shutdown()
                    EOF
            containers:
                - name: reaper
                  {{- if and .Values.multiarch.enabled .Values.multiarch.image.reaper }}
                  image: {{ .Values.multiarch.image.reaper }}
                  {{- else }}
                  image: "{{ .Values.reaper.image.repository }}:{{ .Values.reaper.image.tag }}"
                  {{- end }}
                  imagePullPolicy: {{ .Values.reaper.image.pullPolicy }}
                  command:
                    - /bin/bash
                    - -c
                  args:
                    - |
                      /usr/local/bin/entrypoint.sh cassandra-reaper &
                      child=$!
                      wait "$child"
                      echo "Reaper process exited, exiting wrapper with code 0"
                      exit 0
                  env:
                  {{- range $key, $value := .Values.reaper.env }}
                    - name: {{ $key }}
                      value: {{ $value | quote }}
                  {{- end }}
                  ports:
                    - name: http
                      containerPort: {{ .Values.reaper.port }}
                      protocol: TCP
                  livenessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /ping
                      port: http
                      scheme: HTTP
                    initialDelaySeconds: 120
                    periodSeconds: 10
                    successThreshold: 1
                    timeoutSeconds: 5
                  readinessProbe:
                    failureThreshold: 3
                    httpGet:
                      path: /ping
                      port: http
                      scheme: HTTP
                    initialDelaySeconds: 120
                    periodSeconds: 10
                    successThreshold: 1
                    timeoutSeconds: 5
                  resources:
                    requests:
                      cpu: {{ .Values.reaper.resources.requests.cpu }}
                      memory: {{ .Values.reaper.resources.requests.memory }}
                    limits:
                      cpu: {{ .Values.reaper.resources.limits.cpu }}
                      memory: {{ .Values.reaper.resources.limits.memory }}
                - name: reaper-repair-sidecar
                  {{- if and .Values.multiarch.enabled .Values.multiarch.image.reaper_repair }}
                  image: {{ .Values.multiarch.image.reaper_repair }}
                  {{- else }}
                  image: "{{.Values.reaper.sidecar.image.repository}}:{{.Values.reaper.sidecar.image.tag}}"
                  {{- end }}
                  imagePullPolicy: {{.Values.reaper.sidecar.image.pullPolicy}}
                  env:
                  {{- range $key, $value := .Values.reaper.sidecar.env }}
                    - name: {{ $key }}
                      value: {{ $value | quote }}
                  {{- end }}
                  resources:
                    {{- toYaml .Values.reaper.sidecar.resources | nindent 20 }}
            imagePullSecrets: 
                - name: {{ .Values.image.pullSecrets }}
{{- end}}
{{- end}}
