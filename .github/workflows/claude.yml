name: Claude PR Review

on:
  issue_comment:
    types: [created]
  pull_request_review_comment:
    types: [created]
  pull_request_review:
    types: [submitted]
  pull_request:
    types: [opened, synchronize, ready_for_review]

jobs:
  # Job 1: Respond to @claude mentions in comments
  claude-respond:
    if: |
      (github.event_name == 'issue_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review_comment' && contains(github.event.comment.body, '@claude')) ||
      (github.event_name == 'pull_request_review' && contains(github.event.review.body, '@claude'))
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      issues: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Run Claude Code
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          trigger_phrase: "@claude"
          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*),Bash(gh pr edit:*)"

  # Job 2: Auto-review PRs on open/sync
  claude-review:
    if: |
      github.event_name == 'pull_request' &&
      !github.event.pull_request.draft
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
      id-token: write
      actions: read
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Claude PR Review
        uses: anthropics/claude-code-action@v1
        with:
          anthropic_api_key: ${{ secrets.ANTHROPIC_API_KEY }}
          track_progress: true
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}
            PR TITLE: ${{ github.event.pull_request.title }}
            PR AUTHOR: ${{ github.event.pull_request.user.login }}

            You are reviewing a PR for Apache Atlas Metastore — a Java 17 / Maven project
            that implements a metadata catalog built on JanusGraph, Cassandra, Elasticsearch, and Kafka.

            ## Project Context
            - Core business logic lives in `repository/` module
            - Entity preprocessors in `repository/src/main/java/org/apache/atlas/repository/store/graph/v2/preprocessor/`
            - REST API layer in `webapp/`
            - API models and client libraries in `intg/`
            - Helm charts in `helm/`
            - CI/CD workflows in `.github/workflows/`

            ## Review Focus Areas

            1. **Java Code Quality**
               - Thread safety (Atlas is multi-threaded)
               - Proper null checks and error handling
               - Resource cleanup (try-with-resources for streams, graph transactions)
               - Consistent use of existing patterns (PreProcessor pattern, store pattern)

            2. **Graph Database Concerns**
               - JanusGraph transaction handling (commit/rollback)
               - Vertex/Edge property access patterns
               - Index usage and query efficiency

            3. **Security**
               - Authorization checks in REST endpoints
               - Input validation (especially qualifiedName, GUID parameters)
               - No secrets or credentials in code

            4. **Performance**
               - N+1 query patterns in graph traversals
               - Unnecessary object creation in hot paths
               - Elasticsearch query efficiency
               - Proper use of caching

            5. **Backward Compatibility**
               - REST API contract changes
               - TypeDef changes that could break existing entities
               - Kafka message format changes

            6. **Helm / CI Changes** (if applicable)
               - Chart version bumps
               - Values.yaml schema changes
               - Workflow correctness

            ## Review Rules — IMPORTANT
            - ONLY leave inline comments for: critical bugs, security vulnerabilities, unexpected runtime issues (NPE, resource leaks, race conditions), or concrete improvement suggestions with code examples
            - Every inline comment MUST reference the specific code line it's about and explain WHY it's a problem — not just describe WHAT the code does
            - NEVER leave positive/affirmation comments like "Good change", "Nice refactoring", "This looks correct" — these are noise and waste reviewers' time
            - NEVER comment on trivial style, formatting, or naming unless it introduces a real bug
            - If you have a suggestion, include a concrete code snippet showing the improvement
            - Use a single top-level PR comment for a brief overall summary
            - If the PR is clean with no real issues, just post a short top-level summary — ZERO inline comments
            - Fewer high-quality comments >> many low-value comments

          claude_args: |
            --allowedTools "mcp__github_inline_comment__create_inline_comment,Bash(gh pr comment:*),Bash(gh pr diff:*),Bash(gh pr view:*)"
